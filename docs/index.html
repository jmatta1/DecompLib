<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>DecompLib: DecompLib</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DecompLib
   </div>
   <div id="projectbrief">A simple library for decomposition of spectra using a response matrix.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">DecompLib </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#sec_intro">Introduction</a></li>
<li class="level1"><a href="#sec_install">Build and Install</a><ul><li class="level2"><a href="#ssec_build">Build</a></li>
<li class="level2"><a href="#ssec_install">Install</a></li>
</ul>
</li>
<li class="level1"><a href="#sec_use">Usage</a></li>
<li class="level1"><a href="#sec_example">Example</a><ul><li class="level2"><a href="#ssec_decompose">DecomposeSpectrum</a></li>
<li class="level2"><a href="#ssec_root1d">RootTh1ToCsv</a></li>
<li class="level2"><a href="#ssec_root2d">RootTh2ToCsv</a></li>
<li class="level2"><a href="#ssec_csv1d">CsvToRootTh1</a></li>
<li class="level2"><a href="#ssec_csv2d">CsvToRootTh2</a></li>
</ul>
</li>
<li class="level1"><a href="#sec_extended">Extended Usage</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="sec_intro"></a>
Introduction</h1>
<p>DecompLib is a small header only template library for decomposing a spectrum into a set of weighted response functions. The decomposition processes is necessary because the response of a detector to mono-energetic incident radiation is not necessarily mono-energetic, let alone at the same energy. Therefore to determine the radiation incident on the detector the detected spectrum must be decomposed using the response matrix (each row encodes the response to a particular mono-energetic input.)</p>
<p>This decomposition can be stated as the following fitting problem: </p><p class="formulaDsp">
\[ S = \sum\limits_{\alpha}f_{\alpha}\times{}\vec{R}_{\alpha} \]
</p>
<p> Where \(S\) is the input spectrum \(\vec{R}_{\alpha}\) are the rows of the response matrix (response functions), and \(f_{\alpha}\) are the weights of the response functions (the incident spectrum). Here though the the various response functions may have a great deal of similarity, causing normal linear algreba methods to fail. The algorithm used in DecompLib will yield positive definite results in a numerically stable fashion. Please see the second half technical report in the DecompLib doc directory for more details.</p>
<p>I ask that, if you use DecompLib in work that you are publishing, that you cite DecompLib</p>
<h1><a class="anchor" id="sec_install"></a>
Build and Install</h1>
<p>Because DecompLib is a header only library it is unnecessary to build anything prior to installing it. The only things that need to be built are the documentation and the example. The next section tells how to build the example and documentation, if you merely wish to install the headers and start using them you can skip straight to the install subsection</p>
<h2><a class="anchor" id="ssec_build"></a>
Build</h2>
<p>If you wish to only build the example and its attendant utilities you need only run <code>make example</code>. Contrariwise, if you wish to only build the documentation simply run <code>make doc</code>. To make both the example and documentation simply run <code>make all</code> or <code>make</code>. This will then build the Example program and the three associated utilities with it. Then it will build the documentation, running doxygen which outputs html and LaTeX, building the doxygen LaTeX output, then building the LaTeX technical report.</p>
<h2><a class="anchor" id="ssec_install"></a>
Install</h2>
<p>Installation of DecompLib is fairly easy, but . In most unix systems you need only decided if you wish to install the library globally across the whole system (requires <code>sudo</code> or root permissions) or if you want to install the library locally.</p>
<p>If you wish to install system wide:</p><ol type="1">
<li>Verify that <code>/usr/include</code> is the correct system header location.<ul>
<li>If it is not correct, edit the line containing <code>Global_Header_Loc=/usr/include</code> to the correct location</li>
</ul>
</li>
<li>Run <code>sudo make install</code></li>
</ol>
<p>If you wish to install locally:</p><ol type="1">
<li>Determine your preferred local install location.<ul>
<li>If you do not wish to install to <code>${HOME}/include</code> edit the line containing <code>Local_Header_Loc=~/include</code> to the prefered location.</li>
</ul>
</li>
<li>Run <code>make local_install</code></li>
</ol>
<h1><a class="anchor" id="sec_use"></a>
Usage</h1>
<p>Usage of the library is simple. One need only instantiate one of each of the three classes, fill them with data, then call the performDecomposition function to decompose the spectrum. Since code is worth more than prose for this a semi-pseudocode example is below.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> numberDataBins = X;</div><div class="line"><a class="code" href="class_data_vector.html">DataVector&lt;double&gt;</a> inputSpectrum(numberDataBins, writeErrorMsgs);</div><div class="line"><span class="comment">//loop to set the inputSpectrum bin values with setElement(bin#, value)</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> numberResponseFunctions = Y;</div><div class="line"><a class="code" href="class_resp_matrix.html">RespMatrix&lt;double&gt;</a> responseMatrix(numberResponseFunctions, numberDataBins, writeErrorMsgs);</div><div class="line"><span class="comment">//nested loop to set the response matrix values with setElement(responseFunction#, bin#, value)</span></div><div class="line"></div><div class="line"><a class="code" href="class_decomp_vector.html">DecompVector&lt;double&gt;</a> parameterSet(numberResponseFunctions, writeErrorMsgs);</div><div class="line">parameterSet.initWithConstant(initialValue);</div><div class="line"></div><div class="line"><span class="comment">//now call performDecomposition</span></div><div class="line"><span class="keywordtype">long</span> <span class="keywordtype">long</span> retVal = <a class="code" href="group___calculation.html#ga255b08dd193b8e7c84f69e1d8437f446">performDecomposition</a>(inputSpectrum, responseMatrix, parameterSet);</div></div><!-- fragment --><p>For more information about the usage and member functions of <a class="el" href="class_data_vector.html" title="A representation of the vector of data that is the object of the decomposition. ">DataVector</a>, <a class="el" href="class_resp_matrix.html" title="A representation of the matrix response functions. ">RespMatrix</a>, and <a class="el" href="class_decomp_vector.html" title="A representation of the vector of decomposition parameters that is passed into the decomposition as a...">DecompVector</a> check out the <a class="el" href="group___i_o.html">Input/Output Classes</a> module.</p>
<p>To learn more about <a class="el" href="group___calculation.html#ga255b08dd193b8e7c84f69e1d8437f446">performDecomposition</a> check out the <a class="el" href="group___calculation.html">Decomposition Functions</a> module.</p>
<h1><a class="anchor" id="sec_example"></a>
Example</h1>
<p>DecompLib contains a directory called Example. This directory contains a program demonstrating the usage of DecompLib as well as four utility functions to assist with the input and output to the example.</p>
<h2><a class="anchor" id="ssec_decompose"></a>
DecomposeSpectrum</h2>
<p>The Example/DecomposeSpectrum subdirectory contains the actual usage example. In addition to the program <code>decompose</code> it contains a sample input spectrum in csv format and a sample response matrix in a gzip compressed csv format (it will need to be uncompressed for use). After being built you can run the example as follows <code>./decompose &lt;spectrumCsvFile&gt; &lt;responseMatrixCsvFile&gt; &lt;outputFileBase&gt;</code>.</p>
<p>Notes: outputFileBase is prefixed onto "_init.csv" (the initial decomposition values spectrum), "_final.csv" (the final decomposition values spectrum), "_sum.csv" (the sum of response functions from the matrix weighted by the final decomposition values), and "_resid.csv" (the weighted sum subtracted from the input spectrum).</p>
<p>Before <code>decompose</code> performs the decomposition it asks several quesions about the parameters that go into the decomposition. How to set the initial <a class="el" href="class_decomp_vector.html" title="A representation of the vector of decomposition parameters that is passed into the decomposition as a...">DecompVector</a> guess, what is the threshold for ignoring parameters when checking convergence, what is the convergence criterion. It also asks what limits of bin numbers it should use for the spectrum and response matrix. For the sample response matrix and spectrum included the X-axis limits that will pass the safety checks are [0, 3049] and the Y-axis limits that will pass the safety checks are [4, 1499], narrower limits can be chosen, but not broader. Additionally, the X-axis limits for the response matrix and the limits for the spectrum should always be the same.</p>
<h2><a class="anchor" id="ssec_root1d"></a>
RootTh1ToCsv</h2>
<p>The Example/RootTh1ToCsv contains a utility that will take a root file and the name of any TH1(F,D,I...) in that file and output it to a specified csv format file. After being built it can be invoked as follows: <code>./convert1d &lt;inputRootFile&gt; &lt;Th1Name&gt; &lt;outputFile&gt;</code></p>
<h2><a class="anchor" id="ssec_root2d"></a>
RootTh2ToCsv</h2>
<p>The Example/RootTh2ToCsv contains a utility that will take a root file and the name of any TH2(F,D,I...) in that file and output it to a specified csv format file. After being built it can be invoked as follows: <code>./convert2d &lt;inputRootFile&gt; &lt;Th2Name&gt; &lt;outputFile&gt;</code></p>
<h2><a class="anchor" id="ssec_csv1d"></a>
CsvToRootTh1</h2>
<p>The Example/CsvToRootTh1 contains a utility that a 1D histogram in a csv file and write it into TH1D format in a root file you select. After being built it can be invoked as follows: <code>convert1dCsv &lt;1dHistogramCsv&gt; &lt;outputRootFile&gt; &lt;Th1Name&gt;</code></p>
<h2><a class="anchor" id="ssec_csv2d"></a>
CsvToRootTh2</h2>
<p>The Example/CsvToRootTh1 contains a utility that a 2D histogram in a csv file and write it into TH2F format in a root file you select. After being built it can be invoked as follows: <code>convert2dCsv &lt;2dHistogramCsv&gt; &lt;outputRootFile&gt; &lt;Th2Name&gt;</code></p>
<h1><a class="anchor" id="sec_extended"></a>
Extended Usage</h1>
<p>This is a greatly expanded version of the usage pseudocode from above. It includes comments explaining more about choices as well as showing where default parameters were chosen in function calls above.</p>
<div class="fragment"><div class="line"><span class="comment">//decide what floating point type will be used for everything</span></div><div class="line"><span class="keyword">typedef</span> <span class="keywordtype">double</span> fp_type;</div><div class="line"></div><div class="line"><span class="comment">//Safety checks (looking for bad inputs etc) can output messages to std::cout if</span></div><div class="line"><span class="comment">//true is passed for certain parameters, look for this boolean in declarations and calls below</span></div><div class="line"><span class="keywordtype">bool</span> writeErrorMsgs = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="comment">//make the DataVector which contains the input spectrum</span></div><div class="line"><span class="keywordtype">int</span> numberDataBins = X;</div><div class="line"><a class="code" href="class_data_vector.html">DataVector&lt;fp_type&gt;</a> inputSpectrum(numberDataBins, writeErrorMsgs);</div><div class="line"><span class="comment">//set the data vector</span></div><div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numberDataBins; ++i)</div><div class="line">{</div><div class="line">    inputSpectrum.setElement(i, SpectrumDataSource.GetBinContent(i));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//make the RespMatrix which response matrix with which to do the decomposition,</span></div><div class="line"><span class="comment">//it must have the same number of bins per response function as the input spectrum has bins</span></div><div class="line"><span class="keywordtype">int</span> numberResponseFunctions = Y;</div><div class="line"><a class="code" href="class_resp_matrix.html">RespMatrix&lt;fp_type&gt;</a> responseMatrix(numberResponseFunctions, numberDataBins, writeErrorMsgs);</div><div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numberResponseFunctions; ++i)</div><div class="line">{</div><div class="line">    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;numberDataBins; ++j)</div><div class="line">    {</div><div class="line">        responseMatrix.setElement(i, j, ResponseFunctionArray[i].GetBinContent(i));</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//make the DecompVector which will hold the initial guess, it must have as many bins</span></div><div class="line"><span class="comment">//as there are response functions in the RespMatrix</span></div><div class="line"><a class="code" href="class_decomp_vector.html">DecompVector&lt;fp_type&gt;</a> initGuess(numberResponseFunctions, writeErrorMsgs);</div><div class="line"><span class="comment">//there are two options to initialize a DecompVector beyond simply setting every bin</span></div><div class="line"><span class="comment">//you can pass it a filled input spectrum along with an offset and scaling factor</span></div><div class="line"><span class="comment">//it will then fill it self with an offset and scaled sub sampling of the input spectrum</span></div><div class="line"><span class="comment">//this is accomplished using the initWithDataVector member function</span></div><div class="line">initGuess.initWithDataVector(*inputSpectrum, scalingFactor, offsetValue);</div><div class="line"><span class="comment">//you can also initialize the DecompVector to a constant value. This is recommended</span></div><div class="line"><span class="comment">//as it seems to encode less noise into the final result</span></div><div class="line"><span class="comment">//this is accomplished using the initWithConstant member function</span></div><div class="line">initGuess.initWithConstant(initialValue);</div><div class="line"></div><div class="line"><span class="comment">//because we may want to keep the initial guess on hand and the initial guess</span></div><div class="line"><span class="comment">//passed to performDecomposition is overwritten with the final result, we use the</span></div><div class="line"><span class="comment">//copy constructor of DecompVector in order to have two copies, one to keep and</span></div><div class="line"><span class="comment">//one to pass to performDecomposition</span></div><div class="line"><a class="code" href="class_decomp_vector.html">DecompVector&lt;fp_type&gt;</a> parameterSet(initGuess);</div><div class="line"></div><div class="line"><span class="comment">//Here I set the value below which a parameter is not considered when determining</span></div><div class="line"><span class="comment">//if the algorithm has yet converged. This is useful because for very small number</span></div><div class="line"><span class="comment">//the nature of floating point math is that they will start to change very quickly</span></div><div class="line"><span class="comment">//especially if the algorithm is moving them towards zero (though it will never reach</span></div><div class="line"><span class="comment">//there). The exact value of this will depend on the nature of the spectra you are</span></div><div class="line"><span class="comment">//decomposing 1e-6 works in the sample spectrum and response matrix included with</span></div><div class="line"><span class="comment">//with the Example</span></div><div class="line">fp_type minConvThresh = 1.0e-6;</div><div class="line"></div><div class="line"><span class="comment">//Here I set the maximum fractional change that a parameter can show between</span></div><div class="line"><span class="comment">//iterations before it is declared unconverged, I am uncertain if good values</span></div><div class="line"><span class="comment">//for this will change with different problems. I suspect that it will, but that</span></div><div class="line"><span class="comment">//the changes will be small compared to the changes that can occur in minConvThresh</span></div><div class="line">fp_type convergenceCriterion = 0.005;</div><div class="line"></div><div class="line"><span class="comment">//now call performDecomposition</span></div><div class="line"><span class="keywordtype">long</span> <span class="keywordtype">long</span> retVal = <a class="code" href="group___calculation.html#ga255b08dd193b8e7c84f69e1d8437f446">performDecomposition</a>(inputSpectrum, responseMatrix,</div><div class="line">                                        parameterSet, minConvThresh,</div><div class="line">                                        convergenceCriterion, writeErrorMsgs);</div><div class="line"><span class="comment">//if retVal is not negative, it contains the number of iterations required for convergence</span></div><div class="line"><span class="comment">//if retVal is negative then there was an error and the decompositon was not performed</span></div><div class="line"></div><div class="line"><span class="comment">//if the decomposition was run then you can retrieve the results using the DecompVector</span></div><div class="line"><span class="comment">//member function `getElement(binNumber)`</span></div></div><!-- fragment --><p>To learn more about the particular pitfalls that are possible with the algorithm please see the second half technical report in the DecompLib doc directory. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
